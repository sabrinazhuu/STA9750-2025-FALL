---
title: "Citi Bike Usage in NYC"
subtitle: "STA 9750 Individual Final Report"
author: "Sabrina Zhu"
date: today
editor:
    mode: source
format:
    html:
        code-fold: true
---

\

::: {.callout-note icon="false" style="padding: 16px 20px;"}
## Project Overview

**Data Period:** October 2024 – October 2025

**Data Source:**

-   Bike data from [Citi Bike System Data](https://citibikenyc.com/system-data)
-   Bike Routes from [NYC Open Data](https://catalog.data.gov/dataset/new-york-city-bike-routes)

**Project Structure:**

1.  Introduction & Research Question
2.  Methodology (Infrastructure Classification)
3.  Results (E-bike Usage Analysis)
4.  Multi-Dimensional Analysis
5.  Discussion & Conclusion
:::

\

# Introduction

The rise of electric bikes (e-bikes) has transformed urban cycling, offering riders an easier, faster, and less physically demanding alternative to traditional bikes. In New York City's Citi Bike system, e-bikes have become increasingly popular, now accounting for approximately 68% of all trips in Manhattan. This shift raises important questions about how infrastructure and external factors influence rider choices between e-bikes and classic bikes.

This analysis is part of a group project investigating our overarching question:

> Among weather, time, location, and other rider characteristics, which variables are the most important drivers of Citi Bike trip volume in Manhattan?

While my teammates examine factors like weather, time of day, and rider demographics, my contribution focuses on whether infrastructure affects not just how much people ride, but what they choose to ride.

Understanding the relationship between infrastructure and bike type usage has practical implications for urban planning and bike-share operations. If infrastructure quality directly influences bike type preferences, cities might prioritize different investments. Alternatively, if the relationship is more complex and driven by demand patterns rather than infrastructure itself, operators might focus on re-balancing and supply management strategies.

## Research Question

> **Specific Question:** How does station infrastructure relate to e-bike vs classic bike usage?

Rather than looking at overall ridership volume, this question isolates bike choice as the outcome of interest. The goal is to understand whether characteristics of station infrastructure, such as station density and nearby bike lane protection, are associated with a higher share of e-bike trips compared to classic bikes. This helps separate where people ride more from what people choose to ride once they are already using Citi Bike.

The initial assumption was that stronger infrastructure would align with higher e-bike usage, since protected lanes and dense station networks may support faster and more confident riding. However, the analysis reveals a more complex relationship, suggesting that availability, trip context, and rider behavior may play a larger role than infrastructure quality alone.

### Data Overview
```{r}
#| label: setup

library(data.table)
library(sf)
library(ggplot2)
library(dplyr)

# Create manhattan polygon if it doesn't exist
if (!file.exists("data/gis/manhattan_polygon.rds")) {
  dir.create("data/gis", showWarnings = FALSE, recursive = TRUE)
  
  borough_url <- "https://www.nyc.gov/assets/planning/download/zip/data-maps/open-data/nybb_16a.zip"
  borough_zip <- "data/gis/nyc_boroughs.zip"
  
  download.file(borough_url, borough_zip, mode = "wb")
  unzip(borough_zip, exdir = "data/gis")
  
  shp_file <- list.files("data/gis", pattern = "\\.shp$", recursive = TRUE, full.names = TRUE)[1]
  
  boroughs <- st_read(shp_file, quiet = TRUE)
  boroughs <- st_transform(boroughs, 4326)
  manhattan_poly <- boroughs[boroughs$BoroName == "Manhattan", ]
  
  saveRDS(manhattan_poly, "data/gis/manhattan_polygon.rds")
}
```
This analysis uses a 5% stratified sample of Citi Bike trip data from Manhattan, spanning October 2024 through October 2025. The sample includes over 1.6 million trips, stratified by date to ensure representative coverage across all time periods and seasonal variations. This sampling approach maintains the temporal distribution of the original dataset while reducing computational demands for analysis.

Additionally, I incorporated NYC bike route infrastructure data from the NYC Department of Transportation to classify stations by their proximity to bike lanes and the density of nearby stations. This spatial dataset includes information on bike lane locations, types (protected, conventional, shared), and connectivity across the Manhattan street network. By combining trip data with infrastructure data, we can examine whether the cycling environment around each station influences what type of bike people choose to ride.

The analysis focuses specifically on the choice between electric and classic bikes, treating this as a binary outcome for each trip. While Citi Bike also offers dockless e-bikes in some areas, these represent a small fraction of the overall fleet and are excluded from this analysis to maintain consistency across the network.

```{r}
#| label: load-data

citibike_sample <- readRDS("data/processed/citibike_manhattan_sample_5pct.rds")
routes <- readRDS("data/individual_report/bike_routes.rds")
manhattan_poly <- readRDS("data/gis/manhattan_polygon.rds")

cat("Loaded", format(nrow(citibike_sample), big.mark = ","), "trips\n")
cat("Date range:", as.character(min(citibike_sample$date)), 
    "to", as.character(max(citibike_sample$date)), "\n")
```

# Methodology

## Rider Type Distribution

Before examining infrastructure effects, it is important to understand the baseline distribution of bike type usage across different rider categories. Citi Bike distinguishes between two rider types: members (annual subscribers) and casual riders (single-ride or day-pass users). These groups may have fundamentally different riding behaviors, preferences, and sensitivities to various factors.

```{r}
#| label: rider-summary

rider_summary <- citibike_sample[, .(
  total_trips = .N,
  electric_bikes = sum(rideable_type == "electric_bike"),
  classic_bikes = sum(rideable_type == "classic_bike")
), by = member_casual]

rider_summary[, `:=`(
  pct_electric = round(electric_bikes / total_trips * 100, 1),
  pct_classic = round(classic_bikes / total_trips * 100, 1)
)]

knitr::kable(rider_summary, 
             col.names = c("Rider Type", "Total Trips", "Electric Bikes", 
                          "Classic Bikes", "% Electric", "% Classic"),
             format.args = list(big.mark = ","))
```

The data reveals several important baseline patterns. Overall, e-bike usage averages 68% across all trips, indicating a strong general preference for electric bikes. However, this preference varies by rider type. Casual riders show a higher e-bike preference at 73.2%, compared to members at 66.9%—a gap of approximately 6 percentage points.

This difference likely reflects several factors. Casual riders, who may be tourists or occasional users, might prefer the easier riding experience that e-bikes provide, especially when navigating unfamiliar routes. Members, who ride more frequently, may be more price-conscious given the additional fee for e-bike usage. Regular commuters might also prefer the predictability of classic bikes for their daily routines.

Notably, members account for 78% of all trips despite having lower e-bike usage rates. This means that member behavior heavily influences overall system patterns, and any infrastructure effects on members will have outsized impacts on aggregate statistics.

## Infrastructure Classification Methodology

To examine the relationship between infrastructure and bike type usage, I developed a composite infrastructure score for each Citi Bike station. This score combines two metrics that capture different aspects of cycling infrastructure quality.

The first metric is **station density**, measured as the number of other Citi Bike stations within a 500-meter radius. Higher station density indicates better network coverage, providing riders with more options for starting and ending trips. Dense station networks reduce the walking distance to find an available bike and increase the likelihood of finding docking space at the destination.

The second metric is **bike lane proximity**, measured as the distance from each station to the nearest bike lane. Stations closer to bike lanes offer riders immediate access to dedicated cycling infrastructure, potentially making both e-bike and classic bike rides safer and more comfortable.

```{r}
#| label: infrastructure-classification

# Get unique stations with coordinates
stations <- citibike_sample[!is.na(start_station_id) & 
                             !is.na(start_lat) & 
                             !is.na(start_lng), 
                           .(lat = first(start_lat),
                             lng = first(start_lng),
                             station_name = first(start_station_name)),
                           by = start_station_id]

# Convert to spatial object
stations_sf <- st_as_sf(stations, coords = c("lng", "lat"), crs = 4326, remove = FALSE)

# Metric 1: Station Density (count nearby stations within 500m)
stations_buffer <- st_buffer(stations_sf, dist = 500)
stations$nearby_count <- sapply(1:nrow(stations_sf), function(i) {
  sum(st_intersects(stations_buffer[i, ], stations_sf, sparse = FALSE)) - 1
})

# Metric 2: Distance to Bike Lanes
manhattan_bbox <- st_bbox(c(xmin = -74.02, xmax = -73.90, ymin = 40.70, ymax = 40.88), 
                          crs = st_crs(4326)) |> st_as_sfc()

manhattan_routes_sf <- routes %>%
  filter(st_intersects(geometry, manhattan_bbox, sparse = FALSE)[,1]) %>%
  st_transform(4326)

stations$dist_to_bike_lane_m <- sapply(1:nrow(stations_sf), function(i) {
  distances <- st_distance(stations_sf[i, ], manhattan_routes_sf)
  min(as.numeric(distances))
})

# Create Infrastructure Score (normalized 0-1)
stations$density_score <- (stations$nearby_count - min(stations$nearby_count)) / 
  (max(stations$nearby_count) - min(stations$nearby_count))

max_dist <- quantile(stations$dist_to_bike_lane_m, 0.95)
stations$lane_proximity_score <- 1 - pmin(stations$dist_to_bike_lane_m, max_dist) / max_dist

stations$infrastructure_score <- 0.5 * stations$density_score + 0.5 * stations$lane_proximity_score

# Classify into tertiles
tertiles <- quantile(stations$infrastructure_score, probs = c(0.33, 0.67))
stations$infrastructure_level <- cut(
  stations$infrastructure_score,
  breaks = c(-Inf, tertiles[1], tertiles[2], Inf),
  labels = c("Low", "Medium", "High"),
  include.lowest = TRUE
)

# Save station classification
saveRDS(stations, "data/processed/stations_infrastructure.rds")
```

Both metrics were normalized to a 0-1 scale and combined with equal weights to create the composite infrastructure score. Stations were then classified into three categories—Low, Medium, and High infrastructure—based on tertiles of this score. This classification allows for meaningful comparisons across infrastructure levels while maintaining sufficient sample sizes in each category.

The resulting classification reveals a clear geographic pattern, as shown in the infrastructure map below. High-infrastructure stations (shown in green) concentrate in Lower Manhattan and Midtown, where station density is highest and bike lanes are most prevalent. Low-infrastructure stations (shown in red) appear primarily in Upper Manhattan and along the periphery of the network, where stations are more spread out and bike lane coverage is less comprehensive.

```{r}
#| label: map-infrastructure
#| fig-cap: "Station Infrastructure Classification Across Manhattan"
#| fig-width: 10
#| fig-height: 12

ggplot() +
  geom_sf(data = manhattan_poly, fill = "gray95", color = "gray60", size = 0.3) +
  geom_sf(data = manhattan_routes_sf, color = "lightblue", alpha = 0.3, size = 0.5) +
  geom_point(data = stations, 
             aes(x = lng, y = lat, color = infrastructure_level, size = nearby_count),
             alpha = 0.7) +
  scale_color_manual(
    values = c("Low" = "#F44336", "Medium" = "#FF9800", "High" = "#4CAF50"),
    name = "Infrastructure Level"
  ) +
  scale_size_continuous(name = "Station Density", range = c(1, 4)) +
  labs(
    title = "Citi Bike Station Infrastructure",
    subtitle = "Stations classified by bike lane proximity and station density",
    caption = "Size indicates number of nearby stations within 500m"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    legend.position = "right",
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 10, color = "gray40")
  )
```

# Results

## The Counterintuitive Finding

The central finding of this analysis contradicts the initial hypothesis. Rather than showing higher e-bike usage in areas with better infrastructure, the data reveals an **inverse relationship**: high-infrastructure stations actually have lower e-bike usage rates than low-infrastructure stations.

```{r}
#| label: station-ebike

# Calculate e-bike % by station
station_variation <- citibike_sample[, .(
  ebike_pct = mean(rideable_type == "electric_bike") * 100,
  trips = .N,
  lat = mean(start_lat),
  lng = mean(start_lng)
), by = start_station_name]

# Merge with infrastructure
station_full <- merge(station_variation, 
                      stations[, .(station_name, infrastructure_level, infrastructure_score)],
                      by.x = "start_station_name", 
                      by.y = "station_name",
                      all.x = TRUE)

# Calculate bike balance (relative to average)
overall_ebike_share <- mean(citibike_sample$rideable_type == "electric_bike") * 100
station_full[, bike_balance := ebike_pct - overall_ebike_share]

# Summary by infrastructure level
infra_summary <- station_full[!is.na(infrastructure_level), .(
  mean_ebike = round(mean(ebike_pct), 1),
  n_stations = .N
), by = infrastructure_level]

knitr::kable(infra_summary,
             col.names = c("Infrastructure Level", "Mean E-bike Usage %", "Number of Stations"))
```

The table above shows that low and medium infrastructure stations average approximately 72% e-bike usage, while high-infrastructure stations average only 67%—a difference of about 5 percentage points. This pattern is statistically consistent across individual stations, as demonstrated in the scatter plot below.

```{r}
#| label: scatter-plot
#| fig-cap: "Infrastructure Score vs E-bike Usage by Station"
#| fig-width: 10
#| fig-height: 7

ggplot(station_full[!is.na(infrastructure_score) & trips >= 50 & ebike_pct >= 40], 
       aes(x = infrastructure_score, y = ebike_pct)) +
  geom_point(aes(color = infrastructure_level, size = trips), alpha = 0.6) +
  geom_smooth(method = "lm", color = "black", linetype = "dashed", se = TRUE) +
  scale_color_manual(values = c("Low" = "#F44336", "Medium" = "#FF9800", "High" = "#4CAF50"),
                     name = "Infrastructure Level") +
  scale_size_continuous(range = c(1, 6), name = "Total Trips") +
  labs(
    title = "Infrastructure Score vs. E-bike Usage",
    subtitle = "Each dot is a station | Dashed line shows overall trend",
    x = "Infrastructure Score (higher = better infrastructure)",
    y = "E-bike Usage (%)"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"))
```

The scatter plot reveals several important patterns. First, the trend line slopes clearly downward, confirming that higher infrastructure scores correlate with lower e-bike usage. Second, the color distribution reinforces this pattern—red dots (low infrastructure) cluster toward the upper left, while green dots (high infrastructure) cluster toward the lower right. Third, the largest dots, representing the busiest stations, tend to be green (high infrastructure) and show lower e-bike percentages. This last observation provides a crucial clue to understanding the underlying mechanism.

## Geographic Distribution of Bike Type Usage

The geographic pattern of bike type usage becomes clear when mapping each station's e-bike usage relative to the Manhattan average of 68%.

```{r}
#| label: balance-map
#| fig-cap: "Bike Type Balance Across Manhattan Stations"
#| fig-width: 10
#| fig-height: 12

ggplot() +
  geom_sf(data = manhattan_poly, fill = "gray95", color = "gray60", linewidth = 0.3) +
  geom_point(data = station_full[trips >= 50],
             aes(x = lng, y = lat, color = bike_balance, size = trips),
             alpha = 0.9) +
  scale_color_gradientn(
    colors = c("#08306b", "#2171b5", "#6baed6", "#f7f7f7", "#fcbba1", "#fb6a4a", "#cb181d"),
    values = scales::rescale(c(-60, -30, -10, 0, 10, 25, 40)),
    limits = c(-60, 40),
    breaks = c(-30, 0, 20),
    labels = c("More classic", "Near avg", "More e-bikes"),
    name = "Relative E-bike Share"
  ) +
  scale_size_continuous(range = c(2, 7), name = "Station\nTrip Volume", labels = scales::comma) +
  labs(
    title = "Where Are Stations More or Less E-bike-Heavy?",
    subtitle = sprintf("Color shows difference from Manhattan average (~%.0f%% e-bikes): orange = higher, blue = lower", overall_ebike_share),
    caption = "Data: Citi Bike Manhattan trips | Stations with 50+ trips shown"
  ) +
  coord_sf(datum = NA) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    legend.position = "right",
    plot.title = element_text(size = 14, face = "bold"),
    plot.subtitle = element_text(size = 10, color = "gray40")
  )
```

The map tells a compelling geographic story. Lower Manhattan and Midtown—the areas with the highest infrastructure scores—appear predominantly blue, indicating below-average e-bike usage. Upper Manhattan and the network periphery—areas with lower infrastructure scores—appear predominantly orange, indicating above-average e-bike usage.

This pattern seems paradoxical until we consider demand. The high-infrastructure areas of Lower Manhattan and Midtown are also the highest-demand areas of the Citi Bike network. These neighborhoods serve major employment centers, transit hubs, and tourist destinations. The volume of riders competing for bikes at these stations is substantially higher than in residential Upper Manhattan.

## Explaining the Pattern: Demand Depletes Supply

The inverse relationship between infrastructure and e-bike usage is best explained by supply and demand dynamics rather than rider preferences. E-bikes are generally preferred by riders—as evidenced by the 68% overall usage rate. However, e-bikes are a limited resource that gets depleted faster at high-demand stations.

When a rider arrives at a busy Midtown station during rush hour, they may *want* an e-bike, but if all e-bikes have already been taken by earlier riders, they must settle for a classic bike. In contrast, a rider arriving at a quieter Upper Manhattan station is more likely to find e-bikes available simply because fewer riders are competing for them.

This interpretation is supported by the observation that the largest stations (biggest dots in the scatter plot) tend to have the lowest e-bike percentages. Station size correlates with demand, and high demand leads to e-bike depletion.

## Multi-Dimensional Analysis

To further test this interpretation and examine whether the pattern holds across different conditions, I analyzed e-bike usage across three dimensions simultaneously: rider type, station traffic level, and time of day.

```{r}
#| label: heatmap-data

# Define time periods
citibike_sample[, time_period := fcase(
  hour %in% c(6,7,8,9), "Morning Rush",
  hour %in% c(10,11,12,13,14,15), "Midday",
  hour %in% c(16,17,18,19), "Evening Rush",
  hour %in% c(20,21,22,23,0,1,2,3,4,5), "Night"
)]
citibike_sample[, time_period := factor(time_period, 
  levels = c("Morning Rush", "Midday", "Evening Rush", "Night"))]

# Define volume groups
citibike_sample[, station_volume := .N, by = start_station_name]
citibike_sample[, volume_group := cut(station_volume, 
  breaks = quantile(station_volume, probs = c(0, 0.33, 0.67, 1)),
  labels = c("Low Traffic", "Medium Traffic", "High Traffic"),
  include.lowest = TRUE)]

# Calculate e-bike % by rider type, volume, and time
ebike_full <- citibike_sample[!is.na(volume_group) & !is.na(time_period), .(
  ebike_pct = mean(rideable_type == "electric_bike") * 100,
  trips = .N
), by = .(member_casual, volume_group, time_period)]

ebike_full[, rider_label := ifelse(member_casual == "casual", "Casual Riders", "Members")]
```

```{r}
#| label: heatmap
#| fig-cap: "E-bike Usage Patterns Across Multiple Dimensions"
#| fig-width: 12
#| fig-height: 6

ggplot(ebike_full, aes(x = time_period, y = volume_group, fill = ebike_pct)) +
  geom_tile(color = "white", size = 1.5) +
  geom_text(aes(label = paste0(round(ebike_pct, 1), "%")),
            size = 4.5, fontface = "bold", color = "white") +
  facet_wrap(~rider_label) +
  scale_fill_gradient2(
    low = "#3498db",
    mid = "#95a5a6",
    high = "#e74c3c",
    midpoint = 68,
    name = "E-bike\nUsage",
    limits = c(60, 80),
    breaks = seq(60, 80, 5),
    labels = function(x) paste0(x, "%")
  ) +
  labs(
    title = "E-bike Usage Patterns Across Multiple Dimensions",
    subtitle = "Blue = More classic bikes | Red = More e-bikes | Overall average = 68% e-bikes",
    x = "Time of Day",
    y = "Station Activity Level",
    caption = "Rider Type Distribution: Casual – 22% | Member – 78%"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 11),
    axis.text.y = element_text(size = 11),
    strip.text = element_text(size = 14, face = "bold"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0),
    plot.subtitle = element_text(size = 11, color = "gray30"),
    plot.caption = element_text(hjust = 0, size = 9),
    panel.grid = element_blank(),
    legend.position = "right"
  )
```

The heatmap reveals several important patterns that support the demand-based interpretation.

**Highest e-bike usage (78.8%)** occurs for casual riders at low-traffic stations during evening rush. This combination represents the ideal conditions for e-bike availability: low-demand stations where e-bikes have not been depleted, ridden by casual users who strongly prefer e-bikes, during evening hours when riders want an easier ride home after a long day.

**Lowest e-bike usage (63.5%)** occurs for members at high-traffic stations during morning rush. This represents the worst conditions for e-bike availability: high-demand stations where e-bikes get taken quickly, used by members who ride frequently during the peak commute period when competition for bikes is most intense.

The gap between these extremes is 15 percentage points—a substantial difference that cannot be explained by preferences alone. Both casual riders and members show the same general pattern: e-bike usage is higher at low-traffic stations and during evening hours. This consistency across rider types suggests that availability, rather than preference differences, drives the pattern.

Higher e-bike usage at low-traffic stations and during evening rush suggests that riders prefer the easier ride home after a long day, and e-bikes are actually available to take at these times and locations.

# Discussion

## Implications for the Overarching Research Question

This analysis contributes to our group's investigation of which variables most strongly drive Citi Bike trip volume in Manhattan. For bike type choice specifically, the findings suggest that **both infrastructure and external factors matter, but the relationship is complex**.

Infrastructure affects bike type usage, but not in the direct way initially hypothesized. Better infrastructure does not lead to higher e-bike preference. Instead, infrastructure quality correlates with demand, and demand determines e-bike availability. This is an indirect effect: infrastructure → demand → availability → observed bike type usage.

External factors also play a role. Rider type creates a consistent 6-7 percentage point gap in e-bike usage, with casual riders preferring e-bikes more than members. Time of day creates variation, with evening hours showing higher e-bike usage than morning hours. However, these external factors operate on top of the availability constraint—they shift the baseline but do not override the supply limitation.

